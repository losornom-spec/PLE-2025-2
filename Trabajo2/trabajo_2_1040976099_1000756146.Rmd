---
title: "Trabajo2R"
author:
  - name: "Luis Gabriel Osorno Muñoz"
    affiliation: "ID: 1040976099" # Reemplaza con el ID de Luis
    email: "losornom@unal.edu.co" # Reemplaza con el correo de Luis
  - name: "Yamid Urrego Galvis"
    affiliation: "ID: 1000756146" # Reemplaza con el ID del segundo autor
    email: "yurregog@unal.edu.co" # Reemplaza con el correo del segundo autor
date: "2025-10-17"
output: html_document
---


# Luis Gabriel Osorno Muñoz - 1040976099 - losornom@unal.edu.co

# Yamid Urrego Galvis - 1000756146 - yurregog@unal.edu.co

```{r}
rm(list = ls())
```


```{r}
ComposicionHogar <- read.csv(
  file = unz(
    r"(datos\Caracteristicas y composicion del hogar.zip)",
    "Caracter\xa1sticas y composici\xa2n del hogar.CSV"
    ),
  sep = ";"
  )
```

```{r}
FuerzaTrabajo <- read.csv(
  file = unz(
    r"(datos\Fuerza de trabajo.zip)",
    "Fuerza de trabajo.CSV"
    ),
  sep = ";"
  )
```

```{r}
Servicios_Hogar <- read.csv(
  file = unz(
    r"(datos\Servicios_del_hogar.zip)",
    "Servicios del hogar.CSV"
    ),
  sep = ";"
  )

```

```{r}
Salud <- read.csv(
  file = r"(datos\Salud.CSV)", 
  sep = ";"
)
```


```{r}
# librerias usadas
library(tidyverse)
library(dplyr)
library(ggplot2)
library(plotly)
library(maps)
library(sf)
library(leaflet)
library(magrittr)
library(geodata)
library(GGally)
```


**1.** En promedio, ¿cuántos individuos hay por hogar? ¿Cuál es la desviación estándar? 
Realice un gráfico boxplot y un histograma de esta variable.
Saque conclusiones.

```{r}
# Calcular el número de individuos por hogar 

Conteo_Hogar <- ComposicionHogar %>%
  group_by(DIRECTORIO, SECUENCIA_P) %>%
  summarise(Num_Individuos = n()) %>%
  ungroup()

# Promedio y Desviación Estándar 

EstadisticosHogar <- Conteo_Hogar %>%
  summarise(
    Promedio = mean(Num_Individuos),
    Desv_Estandar = sd(Num_Individuos),
    Mediana = median(Num_Individuos)
  )

EstadisticosHogar
```


```{r}
ggplot(Conteo_Hogar, aes(x = "", y = Num_Individuos)) +
  geom_boxplot(fill = "#66CDAA", color = "darkblue") +
  geom_point(data = data.frame(y = EstadisticosHogar$Promedio), aes(x = "", y = y), color = "red", size = 3) +
  labs(
    title = "Boxplot del Número de Individuos por Hogar",
    y = "Número de Individuos",
    x = ""
  )
```

```{r}
ggplot(Conteo_Hogar, aes(x = Num_Individuos)) +
  geom_histogram(binwidth = 1, fill = "seagreen", color = "black") +
  labs(
    title = "Histograma del Número de Individuos por Hogar",
    x = "Número de Individuos",
    y = "Frecuencia (Número de Hogares)"
  )
```


**Conclusiones:**

A partir de la información obtenida, podemos decir que en promedio hay entre dos y tres individuos por hogar con una desviación de uno a dos individuos, lo que nos indica que en Colombia es más común que los hogares estén compuestos por una cantidad reducida de personas. En el boxplot podemos observar con más detalle este comportamiento donde se nota en principio que el tercer cuantil esta en el valor 4, lo que indica que el 75% de los hogares tienen 4 o menos integrantes, esto apoya el hecho de que los datos están concentrados alrededor de la media, sin embargo, se observa claramente una cantidad importante de outliers en los que existe un hogar con 24 personas, lo cual es inusual y debería revisarse con más detalle, pero podría ser posible si se trata de alguna finca o edificio particular. La mediana es 3, valor cercano a la media y que nos dice que el 50% de los hogares tiene 3 o menos integrantes.

Con el histograma podemos notar una distribución asimétrica positiva ya que la mayoría de datos se acumulan a la izquierda y se forma una cola a derecha, esto se debe especialmente a la incidencia de datos atípicos. No se puede olvidar que la variable aleatoria corresponde a conteos, por lo tanto se habla de una distribución discreta. 


**2.** En promedio, ¿cuáles son los ingresos mensuales por hogar? ¿Cuál es la desviación estándar? Realice un gráfico boxplot y un histograma de esta variable. Saque conclusiones.


Para los ingresos mensuales se hará el cálculo de ingresos correspondientes a empleos, arriendos, subsidios, entre otros. Las variables que se hayan medido en escalas diferentes a meses (por ejemplo, trimestral, semestral, anual, etc), estas se llevarán a meses para que sean comparables. 

Las variables a considerar para el cálculo son las siguientes:

- P8624     Ingreso por empleo.

- P6595S1   Recibió alimentos como parte del pago.

- P6605S1   Recibió vivienda como parte del pago.

- P6623S1   Otros ingresos en especie.

- P8626S1   Subsidio de alimentación.

- P8628S1   Auxilio de transporte.

- P8630S1   Subsidio familiar.

- P8631S1   Recibió primas.

- P1087S1A1 Recibió prima de servicios (Se divide entre 12, porque se recibe cada 12 meses).

- P1087S2A1 Prima de navidad (Divide entre 12)

- P1087S3A1 Prima de vacaciones (Se divide entre 12, porque se recibe cada 12 meses)

- P1087S4A1 Bonificaciones.

- P1087S5A1 Pagos o indemnizaciones por accidentes de trabajo.

- P6750     Ganancia neta u honorarios de la actividad.

- P8636S1   Ingresos por trabajo extra u otras ocupaciones

- P8640S1   Ingreso por concepto de trabajo.

- P8642S1   Ingreso por concepto de jubilación, pensión.

- P8644S1   Sostenimiento hijos menores de edad

- P8646S1   Ingresos por arriendo

- P8648S1   Primas por conceptos de jubilación o pensión (en los últimos 12 meses)

- P8650S1A1 Ayudas en dinero de otros hogares o instituciones (en los últimos 12 meses)

- P8652S1   Dinero por venta de propiedades (en los últimos 12 meses)

- P8654S1   Dinero por cesantías, intereses, préstamos (en los últimos 12 meses)


Para el cálculo de los ingresos totales mensuales para cada miembro de la familia, se tomarán cada una de estas variables descritas anteriormente y se sumarán sus respectivos ingresos. Nuevamente, los ingresos que son anuales se llevarán a meses.

```{r}
# Se crea una nueva variable llamada IngresoMensual

FuerzaTrabajo %<>% 
  rowwise() %>% 
  mutate(IngresoMensual=sum(P8624,P6595S1,P6605S1, P6623S1,P8626S1, P8628S1, P8630S1,
                            P8631S1, P1087S1A1/12, P1087S2A1/12, P1087S3A1/12, P1087S4A1,
                            P1087S5A1, P6750, P8636S1, P8640S1, P8642S1, P8644S1, P8646S1,
                            P8648S1/12, P8650S1A1/12, P8652S1/12, P8654S1/12, na.rm = TRUE)) %>% 
  ungroup()

Ingreso_mensual <- FuerzaTrabajo %>%
  group_by(DIRECTORIO, SECUENCIA_P) %>%
  summarise(Ingreso_hogar = sum(IngresoMensual,na.rm = TRUE)) %>% 
  ungroup()
```

El cálculo anterior permite estimar los ingresos hogar, pero existen muchos datos atípicos que no permiten una buena visualización de los gráficos y alteran el cálculo de algunos estadísticos. Por ello, se decide eliminar todos aquellos ingresos por hogar que sean mayores a 10 millones. Esto no se hace basado en algún criterio, solo con el propósito de mejorar la visualización. 

```{r}
Ingreso_mensual %<>%
  filter(Ingreso_hogar <= 10000000)

EstadísticosHogar <- Ingreso_mensual %>%
  summarise(
    Promedio = mean(Ingreso_hogar),
    Desv_Estandar = sd(Ingreso_hogar),
    Q1 = quantile(Ingreso_hogar, 0.25),
    Mediana = median(Ingreso_hogar),
    Q3 = quantile(Ingreso_hogar, 0.75),
    Q_0.9 = quantile(Ingreso_hogar, 0.9)
  )
EstadísticosHogar
```


```{r}
ggplot(Ingreso_mensual, aes(x = "", y = Ingreso_hogar)) +
  geom_boxplot(fill = "#66CDAA", color = "darkblue") +
  geom_point(data = data.frame(y = EstadísticosHogar$Promedio), aes(x = "", y = y), color = "red", size = 3) +
  labs(
    title = "Boxplot los ingresos mensuales por hogar",
    y = "Ingresos mensuales",
    x = ""
  )
```

```{r}
ggplot(Ingreso_mensual, aes(x = Ingreso_hogar)) +
  geom_histogram(fill = "seagreen", color = "black") +
  labs(
    title = "Histograma de los ingresos mensuales por hogar",
    x = "Ingresos mensuales",
    y = "Frecuencia (Número de Hogares)"
  )
```


**Conclusiones**

El boxplot refleja una serie de datos atípicos que corresponden a ingresos por hogar muy altos, usualmente ingresos superiores a 3.9 millones por hogar. Ingresos inferiores a 0.48 millones, son propios de aproximadamente el 25% de los hogares encuestados. La media y la mediana son lejanas, lo cual es una muestra de la asimetría de la distribución de los ingresos. Incluso, si no se eliminaran datos atípicos, estos valores serian aún más distantes. 

En el histograma, podemos observar que la mayoría de los hogares poseen ingresos inferiores a 1.37 millones, el cual es un valor ligeramente más alto que el salario mínimo para el año 2023 que era 1.3 millones. Lo cual es un dato muy alarmante porque refleja la realidad de nuestro país, donde el 55% de la población trabajadora gana menos de un salario y eso que este valor de 1.37 millones representa el ingreso para el hogar, lo cual es aún más preocupante. La distribución de estos valores tiene cola pesada a la derecha, con un sesgo a izquierda que representan los ingresos más bajos por hogar. Es evidente que muy pocos hogares tienen ingresos superiores a los 5 millones. 


**3.** Realice un gráfico nube de puntos de los ingresos mensuales por hogar versus el número de individuos por hogar. ¿Qué observa?

Es importante hacer la claridad de que el gráfico de dispersión es de una variable discreta y una continua, no va generar una nube de punto, precisamente por la naturaleza de la variable "número de individuos". El gráfico se muestra a continuación. 

```{r}
Datos_unidos <- inner_join(Conteo_Hogar, Ingreso_mensual, by = "DIRECTORIO")

ggplot(Datos_unidos, aes(x = Num_Individuos, y = Ingreso_hogar)) +
  geom_point(color = "darkblue", size = 2) +
  labs(
    title = "Relación entre Ingreso del Hogar y Número de Individuos",
    x = "Número de Individuos por Hogar",
    y = "Ingreso Mensual Total por Hogar"
  )

```


**Conclusiones**

En el gráfico anterior se reflejan aspectos similares observados en el gráfico de barras anterior. Pero es complicado dar descripciones porque estas son muy subjetivas y es difícil hacer comentarios. Es notable que aquellos hogares con un mayor número de individuos, posean ingresos entre 2.5 y 3.5 millones (obsérvese los puntos más alejado a la derecha). Es preocupante que hogares tan numerosos (entre 9 y 15 personas), reciban ingresos inferiores a los 2.5 millones, note que al dividir 2.5 millones entre 9, a cada miembro del hogar le corresponden 0.27 millones mensuales, lo cual es muy poco dinero para cada miembro. Igualmente tener cerca de 3.5 millones para 24 miembros del hogar, es una cifra muy alarmante. 


**4.** Realice un mapa de Colombia considerando los ingresos mensuales promedio por hogar para los departamentos con colores por 4 categorías (definidas por usted) e incluyendo la respectiva leyenda.

La función gadm del paquete geodata, posee un mapa de Colombia segmentado por departamento. Se hace uso de este para gráficar. 

```{r}
# Se carga el mapa de Colombia por departamentos, tarda unos segundos (length 5465174 bytes (5.2 MB))

Colombia <- gadm(country = "COL", level = 1, path = tempdir()) %>%  st_as_sf()
```

Se realiza el cálculo del ingreso promedio por departamento, se realiza un inner_join, para su respectivo cálculo. Además se limpian datos missing y filas repetidas, producto del inner_join. 

```{r}
Ingreso_mensual <- inner_join(x = Ingreso_mensual, y = ComposicionHogar[, c("DIRECTORIO", "P756S1", "SECUENCIA_P", "P756S2")],
                  by= join_by(DIRECTORIO, SECUENCIA_P)) %>% remove_missing() %>% distinct()

Ingreso_mensual$P756S1 <- as.factor(Ingreso_mensual$P756S1)

IngresoDepartamento <- Ingreso_mensual %>%
  group_by(P756S1) %>% 
  summarise(Promedio_Dep = mean(Ingreso_hogar)) %>% 
  ungroup()
```

Para colorear el mapa, se toma como criterio de división los cuantiles del ingreso promedio por departamento. 

```{r}
cuantiles <- quantile(IngresoDepartamento$Promedio_Dep, c(0,  0.25, 0.5, .75, 1))

cuantiles[1] <- cuantiles[1]-0.01

IngresoDepartamento$Color <- cut(IngresoDepartamento$Promedio_Dep, 
                                 breaks =cuantiles,
                                 labels = c("#A50021", "#FFAD72", "#72D9FF", "#290AD8"))

# Crear vectores para el Código y el Nombre
Codigo_DANE <- c(
    "5", "8", "11", "13", "15", "17", "18", "19", "20", "23", "25", "27",
    "41", "44", "47", "50", "52", "54", "63", "66", "68", "70", "73", "76",
    "81", "85", "86", "88", "91", "94", "95", "97", "99"
)
Nombre_Departamento <- c(
    "ANTIOQUIA", "ATLÁNTICO", "BOGOTÁ, D.C.", "BOLÍVAR", "BOYACÁ", "CALDAS", 
    "CAQUETÁ", "CAUCA", "CÉSAR", "CÓRDOBA", "CUNDINAMARCA", "CHOCÓ", 
    "HUILA", "LA GUAJIRA", "MAGDALENA", "META", "NARIÑO", "NORTE DE SANTANDER", 
    "QUINDÍO", "RISARALDA", "SANTANDER", "SUCRE", "TOLIMA", "VALLE DEL CAUCA", 
    "ARAUCA", "CASANARE", "PUTUMAYO", "SAN ANDRÉS, PROVIDENCIA Y SANTA CATALINA", 
    "AMAZONAS", "GUAINÍA", "GUAVIARE", "VAUPÉS", "VICHADA"
)

# Crear el data frame
deptos_colombia <- data.frame(
    Codigo_DANE = Codigo_DANE,
    Nombre_Departamento = str_to_title(Nombre_Departamento),
    stringsAsFactors = FALSE
)

IngresoDepartamento <- full_join(IngresoDepartamento, deptos_colombia, by = c("P756S1" = "Codigo_DANE"))

IngresoDepartamento$Nombre_Departamento <- recode(IngresoDepartamento$Nombre_Departamento,
                                    "Bogotá, D.c." = "Bogotá D.C.",
                                    "César" = "Cesar",
                                    "Norte De Santander"="Norte de Santander",
                                    "Valle Del Cauca"="Valle del Cauca",
                                    "San Andrés, Providencia Y Santa Catalina" = "San Andrés y Providencia")

IngresoDepartamento <- full_join(Colombia, IngresoDepartamento, by = c("NAME_1" = "Nombre_Departamento"))

# Crear etiquetas para la leyenda
```

```{r}
IngresoDepartamento %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    fillColor = ~Color,
    color = "black",
    weight = 1,
    fillOpacity = 0.5,
    popup = paste0("Ingreso Promedio Mensual por Hogar: COP ", round(IngresoDepartamento$Promedio_Dep,2))
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("#A50021", "#FFAD72", "#72D9FF", "#290AD8"),
    labels = c("Q1 (Menor a 25%)", "Q2 (25% - 50%)", "Q3 (50% - 75%)", "Q4 (Mayor a 75%)"),
    title = "Ingreso Promedio Mensual por Hogar (COP)"
  )
```


**Conclusiones**:

Basado en el mapa realizado se dan algunas observaciones:

- Aquellos departamentos que poseen un menor ingreso promedio por hogar, son: Amazonas, Caquetá, Cauca, Putumayo, Gaugira, Arauca, Córdoba y Sucre. Principalmente se observa que los menores ingresos son en departamentos perifericos.

- Departamentos que tiene salidas al Océano Pacífico, límites con Venezuela o Brasil, tienen un poco mejores a los departamentos anteriores, pero siguen siendo bajos en comparación con el resto del país.

- Departamentos centrales reflejan ingresos promedio por hogar más altos, como Cundinamarca, Boyacá, Santander, Antioquia y Valle del Cauca.


**5.** Para el departamento con mayores ingresos mensuales promedio por hogar, considere los ingresos mensuales promedio por municipio y realice un mapa con colores por 3 categorías (definidas por usted) e incluyendo la respectiva leyenda.

Basado en los cálculos, el departamento con mayores ingresos es San Andres y Providencia. Este departamento solo cuenta con 3 municipios, entonces para realizar el ejercicio y que se pueda ilustrar de mejor manera, se elegirá el segundo departamento en el cual el ingreso promedio sea el más alto. Basado en los cálculos realizados, este departamento es Meta, si se ignora que Bogotá D.C. es un distrito capital y no un departamento propiamente dicho.


```{r}
# Se crea el mapa del Meta
Municipios <- gadm(country = "COL", level = 2, path = "datos/") %>%
  st_as_sf() %>% 
  filter(NAME_1 == "Meta")
```



```{r}
Ingresos_Hogar_Meta <- Ingreso_mensual %>% filter(P756S1 == "50") %>% 
  group_by(DIRECTORIO, SECUENCIA_P) %>% 
  summarise(Ingreso_hogar = sum(Ingreso_hogar, na.rm = TRUE),
            .groups = "drop")

Ingresos_Hogar_Meta <- inner_join(x= Ingresos_Hogar_Meta, y= Ingreso_mensual[, c("DIRECTORIO", "SECUENCIA_P", "P756S2", "P756S1")],
                  by= join_by("DIRECTORIO", "SECUENCIA_P")) %>% distinct() %>% filter(P756S1 == "50")

Ingresos_Hogar_Meta_Municipios <- Ingresos_Hogar_Meta %>% 
  group_by(P756S2) %>% 
  summarise(Prom_municipio = mean(Ingreso_hogar),
            .groups = "drop")

Ingresos_Hogar_Meta_Municipios$P756S2 <- as.character(Ingresos_Hogar_Meta_Municipios$P756S2)
```


```{r}
cuantiles_Meta <- quantile(Ingresos_Hogar_Meta_Municipios$Prom_municipio, c(0,  0.25, 0.5, .75, 1))

cuantiles_Meta[1] <- cuantiles_Meta[1]-0.01

Ingresos_Hogar_Meta_Municipios$Color <- cut(Ingresos_Hogar_Meta_Municipios$Prom_municipio, 
                                 breaks =cuantiles_Meta,
                                 labels = c("#A50021", "#FFAD72", "#72D9FF", "#290AD8"))

url_meta <- "https://co.wikimedia.org/wiki/Municipios/Meta"

codigo_municipio_META <-  url_meta %>% read_html() %>% html_table() %>% .[[1]]
codigo_municipio_META$Municipio <- str_to_title(codigo_municipio_META$Municipio)
codigo_municipio_META$Código <- as.character(codigo_municipio_META$Código)
codigo_municipio_META$Municipio <- recode(codigo_municipio_META$Municipio,
                                          "Acacias"="Acacías",
                                          "Barranca De Upia"="Barranca de Upía",
                                          "Castilla La Nueva"="Castilla la Nueva",
                                          "Fuente De Oro" = "Fuente de Oro",
                                           "Cubarral"="San Luis de Cubarral",
                                          "Mapiripan"="Mapiripán",
                                          "Lejanias"="Mapiripán",
                                          "Puerto Gaitan"="Puerto Gaitán",
                                          "Puerto Lopez"="Puerto López",
                                          "San Carlos Guaroa"="San Carlos de Guaroa",
                                          "San Juan De Arama"="San Juan de Arama",
                                          "San Martin"="San Martín")

Ingresos_Hogar_Meta_Municipios <- full_join(x=Ingresos_Hogar_Meta_Municipios, y=codigo_municipio_META,
                                            by=join_by("P756S2"=="Código"))

Ingresos_Hogar_Meta_Municipios <- full_join(x=Municipios, y=Ingresos_Hogar_Meta_Municipios,
                                            by=c("NAME_2"="Municipio"))

Ingresos_Hogar_Meta_Municipios[14, 14:16] <- Ingresos_Hogar_Meta_Municipios[16, 14:16]
Ingresos_Hogar_Meta_Municipios <- Ingresos_Hogar_Meta_Municipios[-16, ]

```

```{r}
Ingresos_Hogar_Meta_Municipios %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    fillColor = ~Color,
    color = "black",
    weight = 1,
    fillOpacity = 0.5,
    popup = paste0("Ingreso Promedio Mensual por Hogar: COP ", round(Ingresos_Hogar_Meta_Municipios$Prom_municipio,2))
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("#A50021", "#FFAD72", "#72D9FF", "#290AD8"),
    labels = c("Q1 (Menor a 25%)", "Q2 (25% - 50%)", "Q3 (50% - 75%)", "Q4 (Mayor a 75%)"),
    title = "Ingreso Promedio Mensual por Hogar (COP)"
  )
```


**Conclusiones**

A continuación se dan algunos comentarios sobre el mapa:

- Los municipio con mayores ingresos se encuentran en la parte centro-norte del departamento.

- Es esperable que la capital del departamento (Villavicencio, se encuentre entre los cuantiles superiores),lo cual es esperable ya que las capitales suelen concentrar la actividad económica y los ingresos más altos. 

- Los municipios con los ingresos promedio más bajos (el cuartil inferior) se observan predominantemente en las grandes áreas rurales y periféricas del departamento.

- Estos cuartiles intermedios se encuentran generalmente entre las zonas de ingreso alto (Villavicencio) y las grandes áreas rurales de ingreso bajo.


**6.** Seleccione una de las demás bases de datos de la pestaña Microdatos (“Atención integral de los niños y niñas menores de 5 años”, “Condiciones de vida del hogar y tenencia de bienes (Beneficiarios F.E.A)”, “Condiciones de vida del hogar y tenencia de bienes (programas)”, etc.) que sea de su interés y plantee dos preguntas relacionadas con dicha base de datos, respondiendo con gráficos o tablas de resumen.

Para este item, se toma la base de datos de Servicios del hogar y a continuación se plantean dos preguntas:

**a.** ¿Qué asociación existe entre el consumo de "Electricidad", "Acueducto", "Gas", "Alcantarillado", "Recolección de Basuras" en los hogares?

```{r, warning=FALSE}
ggpairs(
  data = Servicios_Hogar,
  columns = c("P5018", "P5067", "P3163", "P5034", "P5044"),
  columnLabels = c("Electricidad", "Acueducto", "Gas", "Alcantarillado", "Basuras")
)
```

**Conclusiones**

- En la diagonal podemos observar la distribución de cada una de las variables analizada (costo de los servicios en cuestión). Allí vemos que la distribución del costo es muy asimetrica y sesgada a la izquierda, concentrada en valores muy pequeños. 

- En general, se observa una tendencia ligeramente positiva en la mayoría de los gráficos. Esto significa que, a medida que el costo/consumo de un servicio aumenta, el del otro también tiende a aumentar.

- Todos los valores de correlación son positivos, lo que confirma la tendencia observada en los diagramas de dispersión. Sin embargo, la mayoría de los coeficientes de correlación son débiles a moderados. 

- Las correlaciones más fuerte se encuentran entre: Acueducto y Alcantarillado (0.504) (es altamente esperable), Electricidad y Acueducto (0.393) y Alcantarillado y Basuras (0.393)


**b.** Calcule los costos totales de servicios analizados anteriormente para cada uno de los hogares, luego realice un mapa del costo promedio en servicios por departamento. Coloreando en tres tonos, (rojo, amarillo y verde). Rojo para los costos más altos y verde para los menores

Nuevamente para elegir los puntos de corte, se tomará el promedio por departamento y se encontrarán tres cuantiles. 


```{r}
FuerzaTrabajo %<>% 
  rowwise() %>% 
  mutate(IngresoMensual=sum(P8624,P6595S1,P6605S1, P6623S1,P8626S1, P8628S1, P8630S1,
                            P8631S1, P1087S1A1/12, P1087S2A1/12, P1087S3A1/12, P1087S4A1,
                            P1087S5A1, P6750, P8636S1, P8640S1, P8642S1, P8644S1, P8646S1,
                            P8648S1/12, P8650S1A1/12, P8652S1/12, P8654S1/12, na.rm = TRUE)) %>% 
  ungroup()


Gasto_Servicios <- Servicios_Hogar %>% 
  rowwise() %>% 
  mutate(CostoServicios = sum(P5018, P5067, P3163, P5034, P5044)) %>% 
  ungroup() %>% 
  select(DIRECTORIO, SECUENCIA_ENCUESTA, SECUENCIA_P, CostoServicios) %>% 
  remove_missing()

Gasto_Servicios <- inner_join(Gasto_Servicios, ComposicionHogar[, c("DIRECTORIO", "SECUENCIA_ENCUESTA", "SECUENCIA_P","P756S1", "P756S2")]) %>% remove_missing()
```


```{r}
Gasto_Servicios_Departamento <- Gasto_Servicios %>% 
  group_by(P756S1) %>% 
  summarise(Prom_Servicio = mean(CostoServicios),
            .groups = "drop")


Gasto_Servicios_Departamento$P756S1 <- as.character(Gasto_Servicios_Departamento$P756S1)

Gasto_Servicios_Departamento <- full_join(x= deptos_colombia, y = Gasto_Servicios_Departamento,
                                          by = join_by("Codigo_DANE"=="P756S1"))



Gasto_Servicios_Departamento$Nombre_Departamento <- recode(Gasto_Servicios_Departamento$Nombre_Departamento,
                                    "Bogotá, D.c." = "Bogotá D.C.",
                                    "César" = "Cesar",
                                    "Norte De Santander"="Norte de Santander",
                                    "Valle Del Cauca"="Valle del Cauca",
                                    "San Andrés, Providencia Y Santa Catalina" = "San Andrés y Providencia")
Gasto_Servicios_Departamento <- full_join(x=Colombia, y=Gasto_Servicios_Departamento,
                 by=join_by("NAME_1"=="Nombre_Departamento"))


cuantiles_Servicios_Departamento <- quantile(Gasto_Servicios_Departamento$Prom_Servicio, c(0,  0.33, 0.66, 1))

cuantiles_Servicios_Departamento[1] <- cuantiles_Servicios_Departamento[1]-0.01

Gasto_Servicios_Departamento$Color <- cut(Gasto_Servicios_Departamento$Prom_Servicio, 
                                 breaks =cuantiles_Servicios_Departamento,
                                 labels = c("#7FFF00", "#FFD700", "#FF3030"))

```



```{r}
Gasto_Servicios_Departamento %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    fillColor = ~Color,
    color = "black",
    weight = 1,
    fillOpacity = 0.5,
    popup = paste0("Costo promedio de servicios por departamento", round(Gasto_Servicios_Departamento$Prom_Servicio,2))) %>%
  addLegend(
    position = "bottomright",
    colors = c("#7FFF00", "#FFD700", "#FF3030"),
    labels = c("Menor a 33.3%", "33.3% - 66.6%", "Mayor a 66.6%"),
    title = "Costo promedio de servicios por departamento (COP)"
  )
```

**Conclusiones**

A continuación se dan algunas observaciones por región del país:


- Los departamentos en la costa Caribe (como La Guajira, Magdalena, Atlántico, Bolívar, Sucre) y algunos de la Región Andina del norte (como Cesar y Norte de Santander) presentan el mayor costo promedio de servicios (rojo). Esto sugiere que los hogares en estas zonas tienen el consumo o las tarifas más altas del país.

- Departamentos con alta densidad de población y actividad económica, como Antioquia, el Eje Cafetero (Caldas, Risaralda, Quindío), y otros en el centro (como Valle del Cauca, Cauca, Huila, Tolima, Cundinamarca/Bogotá - aunque este último no tiene el contorno claro, se infiere su color por la posición) caen principalmente en el rango intermedio (amarillo).


- La gran mayoría de los departamentos de la Orinoquía (Meta, Vichada, Casanare, Arauca) y la Amazonía (Caquetá, Guaviare, Putumayo, Amazonas, Vaupés, Guainía) están en el rango de menor gasto promedio (verde). Esto podría deberse a una combinación de factores como menor densidad poblacional, menor desarrollo de infraestructura de servicios en algunas áreas, o diferencias en el tipo de servicios disponibles y sus tarifas.

- Es de resaltar que los departamentos de la región Caribe y Pacífica, durante años han luchado contra las altas tasas o costos de la electricidad. 

**7.** Con base en las tres bases de datos anteriores, plantee 10 preguntas que sean de su interés y que implique “UNIR” las tres bases de datos.


**a.** ¿Los hogares que tienen mayores ingresos tienden a pagar más por el servicio de salud?


```{r}
BD7a <- full_join(x=Ingreso_mensual, y = Salud[, c("DIRECTORIO", "SECUENCIA_ENCUESTA", "SECUENCIA_P", "P8551")]) %>% 
  remove_missing() %>% filter(P8551 != 99) %>% distinct()
```

```{r}
BD7a %>% ggplot(aes(x=Ingreso_hogar, y=P8551)) +
  geom_point()
```



```{r}
correlacion_r <- cor(BD7a$Ingreso_hogar, BD7a$P8551, use = "complete.obs")
titulo_correlacion <- sprintf("Correlación: r = %.3f", correlacion_r)

BD7a %>%
  ggplot(aes(x = Ingreso_hogar, y = P8551)) +
  geom_point(aes(color = P8551),alpha = 0.6) +
  scale_color_viridis_c(option = "plasma",
                        name = "Gasto en Salud ($)") +
  labs(title = paste("Relación entre Ingreso del Hogar y Gasto en Salud", "\n", titulo_correlacion),
       x = "Ingreso del Hogar ($)",
       y = "Gasto en Salud ($)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10)
  )
```

**Conclusiones**

El gráfico y el coeficiente $r = 0.209$ confirman que existe una relación lineal positiva, pero es muy débil. El principal factor que impulsa la variación en el gasto en salud no es el ingreso del hogar, sino probablemente otros factores no incluidos en este gráfico, como la necesidad médica, la edad, la ocurrencia de una enfermedad catastrófica o crónica, o el tipo de plan de salud que posean. La necesidad de gastar en salud parece ser independiente de la capacidad económica para la mayoría de la población.


**b.** ¿Cuál es el ingreso promedio de los hogares que pagan medicina prepagada?

Para responder a esta pregunta considere la siguiente información:

- 1: Si

- 2: No

```{r}
BD7b <- Ingreso_mensual %>% 
  group_by(DIRECTORIO, SECUENCIA_P) %>% 
  summarise(Prom_Hogar = mean(Ingreso_hogar))

BD7b <- inner_join(x=BD7b,y=Salud[,c("DIRECTORIO", "SECUENCIA_ENCUESTA", "SECUENCIA_P", "P799S2")]) %>% 
  remove_missing() %>% distinct() %>% 
  group_by(P799S2) %>% 
  summarise(Media = mean(Prom_Hogar)) %>% 
  `rownames<-`(c("SI", "NO"))
```

**Conclusiones**

En la tabla podemos observar que el ingreso promedio de las personas que tienen medicina prepagada es de 4.49 millones, mientras que las que no la tienen su ingreso es de 1.76 millones. Esto refleja una profunda desigualdad en el acceso a la calidad y oportunidad de los servicios de salud, ya que los hogares de mayores ingresos pueden complementar el sistema de salud básico (EPS) con servicios privados. 


**c.** Existe alguna relación entre el estado de salud y el ingreso mensual 

Para responder a esta pregunta considere la siguiente información:

- 1: Muy bueno

- 2: Bueno

- 3: Regular

- 4: Malo

```{r}
BD7c <- Ingreso_mensual %>% 
  group_by(DIRECTORIO, SECUENCIA_P) %>% 
  summarise(Prom_Hogar = mean(Ingreso_hogar))

BD7c <- inner_join(x=BD7c, y=Salud[,c("DIRECTORIO", "SECUENCIA_ENCUESTA", "SECUENCIA_P", "P6127")]) %>% 
  group_by(P6127) %>% 
  summarise(Promedio = mean(Prom_Hogar)) %>% 
  ungroup()
  
BD7c
```


**Conclusiones**

Sí, existe una relación entre el estado de salud percibido y el ingreso promedio del hogar.Esto significa que: A Mejor Estado de Salud $\rightarrow$ Mayor Ingreso: Los hogares donde se percibe un estado de salud como "Muy Bueno" tienen el ingreso promedio más alto ($2,002,683 COP$).A Peor Estado de Salud $\rightarrow$ Menor Ingreso: Los hogares donde se percibe un estado de salud como "Malo" tienen el ingreso promedio más bajo ($1,315,673 COP$).

El Ingreso Influye en la Salud: Un mayor ingreso permite a los hogares acceder a mejores condiciones de vida (vivienda, nutrición, ocio), entornos más seguros y, como vimos en tu dato anterior, a servicios de salud privados (medicina prepagada), lo que se traduce en un mejor estado de salud percibido.


**d.** Que tanto se preocupan las familias por su salud según su nivel de ingresos. Para ellos tome en cuenta el número de consultas realizadas durante el año (odontología, psicología, etc.)



**f.** Con la base de datos "servicios del hogar" analice la correspondencia entre el número de integrantes del hogar con el número de cuartos. (Hacer una tabla de contingencia)



**g.** Compare los gastos en servicios (acueducto, energía, gas, internet, telefonía) con los ingresos del hogar



**h.** ¿De acuerdo al ingreso mensual como son las prácticas de reutilización del agua?



**i.** Anteriormente se calculó el ingreso mensual por Hogar.  Compare y observe las diferencias con el valor dado en la base de datos sobre salud



**j.** ¿Cual es la satisfacción de los hogares con su ingreso comparando con el ingreso mensual que devengan?


**K** ¿En correspondencia con el número de integrantes del hogar considera que el agua disponible es suficiente (P3166 de la base de datos : "Servicios del hogar")?

















